<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ç„¡äººå³¶ã‚µãƒã‚¤ãƒãƒ« - ãƒã‚°ä¿®æ­£å®Œäº†ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --text: #58a6ff; --accent: #1f6feb; --danger: #f85149; --thief: #a371f7; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #c9d1d9; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: var(--panel); padding: 25px; border-radius: 12px; border: 1px solid #30363d; }
        .btn { padding: 10px 18px; margin: 4px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; background: #21262d; color: #c9d1d9; border: 1px solid #f0f6fc1a; transition: 0.2s; }
        .btn:hover { background: #30363d; border-color: #8b949e; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: #238636; color: white; }
        .btn-thief { background: var(--thief); color: white; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .card { background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; position: relative; }
        .card.my-turn { border: 2px solid var(--text); }
        .card.faction-thief { border-left: 5px solid var(--thief); }
        .card.dead { opacity: 0.5; background: #21262d; }
        .log-container { background: #000; height: 200px; overflow-y: scroll; padding: 12px; text-align: left; font-family: 'Consolas', monospace; border-radius: 6px; border: 1px solid #30363d; color: #7ee787; margin: 15px 0; font-size: 0.85em; }
        .badge { font-size: 0.75em; padding: 2px 8px; border-radius: 10px; background: var(--accent); color: white; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: var(--panel); padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; border: 1px solid var(--accent); }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .result-table th, .result-table td { border: 1px solid #30363d; padding: 8px; text-align: center; }
        .result-table th { background: #21262d; }
        input[type="text"], input[type="number"] { padding: 8px; border-radius: 4px; background: #0d1117; color: white; border: 1px solid #30363d; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸï¸ Island Survival</h1>
    
    <div id="setup-ui">
        <p>Status: <strong id="conn-status" style="color:orange;">Initializing...</strong></p>
        <p>Your ID: <strong id="my-id" style="color:var(--text);">---</strong></p>
        
        <div style="margin-bottom: 20px;">
            <label>åå‰: <input type="text" id="username" value="Player" style="width: 150px;"></label>
        </div>

        <div id="connection-controls">
            <button class="btn" onclick="initHost()">éƒ¨å±‹ã‚’ä½œã‚‹(Host)</button>
            <input type="text" id="join-id" placeholder="Host IDã‚’å…¥åŠ›">
            <button class="btn" onclick="initGuest()">å‚åŠ ã™ã‚‹(Guest)</button>
        </div>
        <div id="lobby-list" style="margin-top:20px; color:#8b949e;"></div>
        <button id="start-btn" class="btn btn-success" style="display:none; width:100%; margin-top:15px;" onclick="startGame()">ã‚µãƒã‚¤ãƒãƒ«é–‹å§‹</button>
    </div>

    <div id="game-ui" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h2 id="day-label" style="display:inline;">Day 1</h2><span id="my-faction-badge" class="badge" style="margin-left:10px;">å½¹è·ç¢ºèªä¸­</span></div>
            <div id="phase-label" class="badge">ACTION PHASE</div>
        </div>

        <div class="status-grid" id="status-grid"></div>
        <div class="log-container" id="local-log"></div>

        <div id="action-panel" style="display:none;">
            <p><strong>ğŸ’ å®æ¢ã—</strong> (å¼·é­ãªèº«ä½“: å¤±æ•—ç‡åŠæ¸›)</p>
            <button class="btn" onclick="sendAction('treasure', 0.2, 0)">ã¡ã‚‡ã£ã¨(0.2/0%)</button>
            <button class="btn" onclick="sendAction('treasure', 0.4, 20)">æ™®é€š(0.4/20%)</button>
            <button class="btn" onclick="sendAction('treasure', 0.6, 40)">ã‹ãªã‚Š(0.6/40%)</button>
            <button class="btn" onclick="sendAction('treasure', 0.8, 60)">æœ€å¤§é™(0.8/60%)</button>
            <p><strong>ğŸ£ é‡£ã‚Šãƒ»ä»–</strong></p>
            <button class="btn btn-success" onclick="sendAction('fish')">é‡£ã‚Š(1-3å€‹)</button>
            <button class="btn" onclick="openOverlay('spy')">ç›£è¦–ã™ã‚‹</button>
            <button class="btn" onclick="sendAction('ability')">ç‰¹æ®Šèƒ½åŠ›ã‚’å¾—ã‚‹</button>
            <div id="thief-traps" style="display:none; border:1px solid var(--thief); padding:10px; margin-top:10px; border-radius:8px;">
                <p style="color:var(--thief); margin-top:0;">ğŸ•µï¸ ç›—è³Šå°‚ç”¨ç½ </p>
                <button id="trap-food_terror" class="btn btn-thief" onclick="sendAction('trap', 'food_terror')">é£¯ãƒ†ãƒ­</button>
                <button id="trap-leg_trap" class="btn btn-thief" onclick="sendAction('trap', 'leg_trap')">ãƒˆãƒ©ãƒã‚µãƒŸ</button>
                <button id="trap-theft" class="btn btn-thief" onclick="openOverlay('theft')">çªƒç›—</button>
                <button id="trap-extra_food" class="btn btn-thief" onclick="sendAction('trap', 'extra_food')">è¿½åŠ é£Ÿæ–™</button>
            </div>
        </div>

        <div id="rest-panel" style="display:none;"><p style="color:orange;">è¡Œå‹•ä¸èƒ½</p><button class="btn" onclick="sendAction('skip')">ä¼‘æ¯ã™ã‚‹</button></div>

        <div id="interaction-panel" style="display:none;">
            <h3>ğŸ¤ äº¤æµãƒ»æ®ºå®³ãƒ»æŠ•ç¥¨</h3>
            <div id="trade-ui">
                ç›¸æ‰‹: <select id="give-to"></select>
                ç‰©è³‡: <select id="give-item"><option value="food">é£Ÿæ–™</option><option value="treasure">å®</option></select>
                é‡: <input type="number" id="give-val" value="1" min="0.1" step="0.1" style="width:50px;">
                <button class="btn" onclick="performGive()">è­²æ¸¡</button>
            </div>
            <div id="kill-ui" style="display:none; margin-top:10px;"><span style="color:var(--danger)">ğŸ’€ æ®ºå®³:</span> <select id="kill-to"></select> <button id="kill-btn" class="btn btn-danger" onclick="performKill()">å®Ÿè¡Œ</button></div>
            <div id="vote-section" style="background:rgba(248,81,73,0.1); padding:10px; border-radius:5px; margin-top:10px;">å¯¾è±¡: <select id="vote-to"></select> <button class="btn btn-danger" onclick="performVote()">è¿½æ”¾æŠ•ç¥¨</button></div>
            <button id="ready-btn" class="btn btn-success" style="width:100%; margin-top:15px;" onclick="markReady()">ç¿Œæ—¥ã¸</button>
        </div>

        <div id="result-panel" style="display:none;">
            <h2 id="victory-msg"></h2>
            <div id="score-breakdown" style="font-size:1.1em; color:var(--text);"></div>
            <table class="result-table" id="final-table">
                <thead><tr><th>åå‰</th><th>é™£å–¶</th><th>çŠ¶æ…‹</th><th>é£Ÿæ–™</th><th>å®</th><th>èƒ½åŠ›</th></tr></thead>
                <tbody id="final-body"></tbody>
            </table>
            <button class="btn" style="margin-top:20px;" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
        </div>
    </div>
</div>

<div id="spy-overlay" class="overlay"><div class="modal"><h3>ç›£è¦–å¯¾è±¡</h3><div id="spy-list"></div><button class="btn" onclick="closeOverlay()">æˆ»ã‚‹</button></div></div>
<div id="theft-overlay" class="overlay"><div class="modal"><h3>çªƒç›—å¯¾è±¡</h3><div id="theft-list"></div><button class="btn" onclick="closeOverlay()">æˆ»ã‚‹</button></div></div>

<script>
    const ABILITIES = ["å¼·é­ãªèº«ä½“", "åŠé­šäººã¸ã®è¦šé†’", "ãƒ™ãƒ†ãƒ©ãƒ³", "é‡£ã‚Šè·äºº", "å¤±æ•—ä¿é™º", "ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼ä½“è³ª", "ã‚¾ãƒ³ãƒ“", "ã‚®ãƒ–ã‚¢ãƒ³ãƒ‰ãƒ†ã‚¤ã‚¯"];
    let peer = new Peer({ host: '0.peerjs.com', port: 443, secure: true, debug: 1 });
    let myId, connections = [], hostConn = null, isHost = false;
    let gameState = { 
        players: [], day: 1, phase: 'setup', turnIdx: 0, 
        traps: { foodTerror: false, legTrap: false, nextLegTrap: false },
        trapUsed: { food_terror: false, leg_trap: false, theft: false, extra_food: false },
        pendingThefts: [], history: [], gameEnded: false,
        resultData: null
    };

    peer.on('open', id => { myId = id; document.getElementById('my-id').innerText = id; document.getElementById('conn-status').innerText = "Online"; document.getElementById('conn-status').style.color = "#7ee787"; });
    peer.on('connection', conn => { if (isHost) { connections.push(conn); conn.on('data', d => handleData(d, conn)); } });

    function initHost() { 
        isHost = true; 
        const name = document.getElementById('username').value || "Host";
        addPlayer(myId, name); 
        document.getElementById('start-btn').style.display = 'block'; 
        document.getElementById('connection-controls').style.display = 'none'; 
    }
    function initGuest() { 
        const tid = document.getElementById('join-id').value; 
        const name = document.getElementById('username').value || "Guest";
        if(!tid) return; 
        hostConn = peer.connect(tid); 
        hostConn.on('open', () => { 
            document.getElementById('connection-controls').style.display = 'none'; 
            hostConn.send({ type: 'join', name: name }); 
        }); 
        hostConn.on('data', d => handleData(d)); 
    }
    
    function sync() { if (isHost) connections.forEach(c => c.send({ type: 'sync', state: gameState })); handleData({ type: 'sync', state: gameState }); }

    function handleData(data, conn) {
        if (isHost && data.type === 'join') { addPlayer(conn.peer, data.name); sync(); }
        if (data.type === 'sync') { gameState = data.state; updateUI(); }
        if (isHost) {
            if (data.type === 'action') processAction(data);
            if (data.type === 'ready') { const p = gameState.players.find(x => x.id === data.pId); if(p) p.ready = true; checkPhaseEnd(); }
            if (data.type === 'give') {
                const f = gameState.players.find(x => x.id === data.from); const t = gameState.players.find(x => x.id === data.to);
                const item = data.item || 'food';
                if(f[item] >= data.val) { 
                    f[item] -= data.val; t[item] += data.val; 
                    const itemLabel = item === 'food' ? 'é£Ÿæ–™' : 'å®';
                    pushLog(`${f.name}ãŒ${t.name}ã¸${itemLabel}ã‚’${data.val.toFixed(1)}è­²æ¸¡`, "#58a6ff"); sync(); 
                }
            }
            if (data.type === 'kill') {
                const f = gameState.players.find(x => x.id === data.from); const t = gameState.players.find(x => x.id === data.to);
                if (!f.killedToday) { 
                    f.killedToday = true;
                    if (t.ability === "å¼·é­ãªèº«ä½“") {
                         pushLog(`ğŸ’€ ${f.name}ãŒ${t.name}ã‚’è¥²ã£ãŸãŒã€å¼·é­ãªè‚‰ä½“ãŒåˆƒã‚’å¼¾ã„ãŸï¼`, "#f85149");
                    } else {
                        t.alive = false; 
                        if (f.ability === "ã‚¾ãƒ³ãƒ“") f.food += 2;
                        if (f.ability === "ã‚®ãƒ–ã‚¢ãƒ³ãƒ‰ãƒ†ã‚¤ã‚¯") { f.food += 1; f.treasure += 0.6; }
                        pushLog(`ğŸ’€ äº‹ä»¶ï¼š${f.name}ãŒ${t.name}ã‚’æ®ºå®³ã—ãŸ`, "#f85149"); 
                    }
                    sync(); 
                }
            }
            if (data.type === 'vote') {
                const target = gameState.players.find(x => x.id === data.to);
                if (target.faction === 'thief') { pushLog(`ğŸ¯ è¿½æ”¾æˆåŠŸï¼${target.name}ã¯ç›—è³Šã ã£ãŸã€‚`, "gold"); finishGame("research_win_vote"); }
                else { pushLog(`ğŸš« è¿½æ”¾å¤±æ•—... ${target.name}ã¯ç„¡å®Ÿã ã£ãŸã€‚`, "red"); finishGame("thief_win_vote"); }
            }
        }
    }

    function addPlayer(id, name, cpu = false) {
        if(gameState.players.find(p => p.id === id)) return;
        gameState.players.push({ 
            id, name, isCPU: cpu, food: 3, treasure: 0, ap: 1, 
            ability: "ãªã—", alive: true, ready: false, faction: 'research', 
            lastAction: "æœªè¡Œå‹•", yesterdayAction: "æœªè¡Œå‹•", failFlag: false, killedToday: false,
            veteranActive: false, veteranNext: false, stalkerTarget: null, reviveTimer: 0, canRevive: true
        });
        document.getElementById('lobby-list').innerText = "å‚åŠ è€…: " + gameState.players.map(p => p.name).join(", ");
    }

    function startGame() {
        while (gameState.players.length < 4) addPlayer("CPU"+Math.random(), "CPU-"+(gameState.players.length+1), true);
        gameState.players[Math.floor(Math.random() * gameState.players.length)].faction = 'thief';
        gameState.phase = 'action'; pushLog("=== ã‚²ãƒ¼ãƒ é–‹å§‹ ===", "gold"); sync();
    }

    function processAction(data) {
        const pId = data.playerId || gameState.players[gameState.turnIdx].id;
        const p = gameState.players.find(x => x.id === pId);

        if (data.action === 'skip') { nextTurn(); return; }
        p.ap = 0;
        
        if (data.action === 'treasure') {
            let fp = data.prob; 
            if (gameState.traps.legTrap) fp *= 2; 
            if (p.ability === "å¼·é­ãªèº«ä½“") fp /= 2;
            
            if (Math.random() * 100 < fp) { 
                p.failFlag = true; p.lastAction = "å¤§å¤±æ•—"; 
                let failMsg = `${p.name}ãŒå®æ¢ã—ã§å¤§å¤±æ•—ã—ãŸ`;
                if (p.ability === "å¤±æ•—ä¿é™º") { p.treasure += 0.2; failMsg += " (ä¿é™ºé©ç”¨ å®+0.2)"; }
                pushLog(failMsg, "#f85149", p.id); 
            } else { 
                let gain = data.val;
                if (p.veteranActive) { gain *= 2; }
                p.treasure += gain; 
                if (p.ability === "ãƒ™ãƒ†ãƒ©ãƒ³" && gain >= 0.6) { p.veteranNext = true; }
                p.lastAction = "å®æ¢ã—"; 
                pushLog(`${p.name}ã¯å®ã‚’å…¥æ‰‹ã—ãŸ${p.veteranActive ? '(ãƒ™ãƒ†ãƒ©ãƒ³x2)':''}`, "#7ee787", p.id); 
            }
        } else if (data.action === 'fish') {
            if (p.ability === "åŠé­šäººã¸ã®è¦šé†’") {
                if (Math.random() < 0.67) {
                    p.alive = false;
                    pushLog(`${p.name}ã¯åŠé­šäººã¸ã®è¦šé†’ã«å¤±æ•—ã—ã¦æ­»äº¡ã—ãŸ`, "red");
                    if (isHost) sync(); // æ­»äº¡æ™‚å³åŒæœŸ
                    nextTurn(); return; 
                } else {
                    p.ability = "åŠé­šäºº";
                    pushLog(`${p.name}ã¯åŠé­šäººã«è¦šé†’ã—ãŸï¼`, "#58a6ff", p.id);
                }
            }
            let count = Math.floor(Math.random()*3)+1;
            if (p.ability === "é‡£ã‚Šè·äºº") count += 1;
            if (p.ability === "åŠé­šäºº") count *= 2;
            p.food += count; p.lastAction = "é‡£ã‚Š"; 
            pushLog(`${p.name}ã¯é­šã‚’${count}åŒ¹é‡£ã£ãŸ`, "#7ee787", p.id);

        } else if (data.action === 'ability') {
            if (p.ability === "ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼ä½“è³ª") p.stalkerTarget = null;
            p.ability = ABILITIES[Math.floor(Math.random()*ABILITIES.length)]; 
            p.lastAction = "èƒ½åŠ›å¤‰æ›´"; 
            pushLog(`èƒ½åŠ›ã€${p.ability}ã€‘ã‚’å¾—ãŸ`, "#7ee787", p.id);

        } else if (data.action === 'spy') {
            let targetIdx = data.val;
            if (p.ability === "ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼ä½“è³ª") {
                if (p.stalkerTarget !== null) {
                    targetIdx = gameState.players.findIndex(x => x.id === p.stalkerTarget);
                    pushLog(`ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼ä½“è³ªã«ã‚ˆã‚Šå¯¾è±¡ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“`, "orange", p.id);
                } else {
                    p.stalkerTarget = gameState.players[targetIdx].id;
                }
            }
            const t = gameState.players[targetIdx]; 
            p.lastAction = "ç›£è¦–";
            let act = (t.yesterdayAction === "é‡£ã‚Š" || t.yesterdayAction === "å®æ¢ã—") ? t.yesterdayAction : "ä¸æ˜";
            pushLog(`ğŸ‘ï¸ ç›£è¦–[${t.name}]: é£Ÿæ–™${t.food.toFixed(1)} å®${t.treasure.toFixed(1)} æ˜¨æ—¥:${act}`, "#58a6ff", p.id);

        } else if (data.action === 'trap') {
            gameState.trapUsed[data.val] = true;
            if (data.val === 'food_terror') gameState.traps.foodTerror = true;
            else if (data.val === 'leg_trap') gameState.traps.nextLegTrap = true;
            else if (data.val === 'extra_food') p.food += 4;
            else if (data.val === 'theft') { 
                gameState.pendingThefts.push({ thiefId: p.id, targetIdx: data.prob.targetIdx });
                pushLog(`çªƒç›—ã®ç½ ã‚’ä»•æ›ã‘ãŸ...`, "#a371f7", p.id);
            }
            p.lastAction = "ç½ è¨­ç½®";
            if (data.val !== 'theft') pushLog(`ç½ ã‚’ä»•æ›ã‘ãŸ`, "#a371f7", p.id);
        }
        
        // ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†æ™‚ã«å¿…ãšåŒæœŸã—ã¦ãƒ­ã‚°ã‚’é…ä¿¡ã™ã‚‹
        if (isHost) sync();
        
        nextTurn();
    }

    function nextTurn() {
        while (true) {
            gameState.turnIdx++;
            if (gameState.turnIdx >= gameState.players.length) {
                gameState.phase = 'interaction';
                gameState.players.forEach(p => p.ready = (p.isCPU || !p.alive));
                sync();
                return; 
            }
            const n = gameState.players[gameState.turnIdx];
            if (n.alive && n.ap > 0) {
                if (n.isCPU) setTimeout(() => cpuMove(n), 400);
                else sync();
                break;
            }
        }
    }

    function checkPhaseEnd() { if (gameState.players.every(p => p.ready)) endDay(); else sync(); }

    function endDay() {
        gameState.pendingThefts.forEach(th => {
            const thief = gameState.players.find(x => x.id === th.thiefId);
            const target = gameState.players[th.targetIdx];
            if (thief && target && thief.alive && target.alive) {
                 let s = Math.min(target.treasure, 0.4);
                 target.treasure -= s; 
                 thief.treasure += s;
                 pushLog(`æ˜¨æ™©ã€${target.name}ã‹ã‚‰${s.toFixed(1)}ã®ãŠå®ã‚’ç›—ã¿å‡ºã—ãŸ`, "#a371f7", thief.id);
                 pushLog(`æ˜¨æ™©ã€ä½•è€…ã‹ã«ãŠå®(${s.toFixed(1)})ã‚’ç›—ã¾ã‚ŒãŸï¼`, "#f85149", target.id);
            }
        });
        gameState.pendingThefts = [];

        gameState.players.forEach(p => {
            if (!p.alive && p.reviveTimer > 0) {
                p.reviveTimer--;
                if (p.reviveTimer === 0) {
                    p.alive = true; p.food = 1; p.ap = 1;
                    pushLog(`ğŸ§Ÿ ${p.name}ãŒå¢“å ´ã‹ã‚‰è˜‡ã£ãŸ...`, "#a371f7");
                }
            }
        });

        gameState.players.forEach(p => {
            if (!p.alive) return; 

            if (p.ability === "ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼ä½“è³ª" && p.stalkerTarget) {
                const t = gameState.players.find(x => x.id === p.stalkerTarget);
                if (t && t.alive) {
                    let act = (t.yesterdayAction === "é‡£ã‚Š" || t.yesterdayAction === "å®æ¢ã—") ? t.yesterdayAction : "ä¸æ˜";
                    pushLog(`ğŸ‘ï¸ ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼é€šä¿¡[${t.name}]: é£Ÿæ–™${t.food.toFixed(1)} å®${t.treasure.toFixed(1)} æ˜¨æ—¥:${act}`, "#58a6ff", p.id);
                }
            }

            let con = (p.ability === "å¼·é­ãªèº«ä½“") ? 1.5 : 1.0; 
            if (gameState.traps.foodTerror) con += 1.0; 
            p.food -= con; 
            
            if (p.food < 0) { 
                p.alive = false; pushLog(`${p.name}ãŒé¤“æ­»ã—ãŸ`, "red"); 
            } else {
                if (p.ability === "ã‚¾ãƒ³ãƒ“" && Math.random() < 0.30) {
                    p.alive = false;
                    pushLog(`ğŸ§Ÿ ${p.name}ã¯ä½“ãŒå´©ã‚Œè½ã¡ã¦æ­»äº¡ã—ãŸ(ã‚¾ãƒ³ãƒ“åŠ¹æœ)`, "red");
                    if (p.canRevive) { p.reviveTimer = 2; p.canRevive = false; } 
                }
            }
        });

        if (gameState.day >= 10) return finishGame("timeup");
        gameState.day++; gameState.phase = 'action'; gameState.turnIdx = -1; 
        gameState.traps.foodTerror = false; gameState.traps.legTrap = gameState.traps.nextLegTrap; gameState.traps.nextLegTrap = false;
        
        gameState.players.forEach(p => { 
            p.yesterdayAction = p.lastAction; p.lastAction = "æœªè¡Œå‹•"; p.ready = false; p.killedToday = false; 
            p.veteranActive = p.veteranNext; p.veteranNext = false; 
            if (p.alive) { p.ap = p.failFlag ? 0 : 1; p.failFlag = false; } 
        });
        
        nextTurn();
    }

    function finishGame(reason) {
        let surRes = 0, resTr = 0;
        gameState.players.forEach(p => { if (p.faction === 'research' && p.alive) { surRes++; resTr += p.treasure; } });
        let score = (surRes * 10) + (resTr * 6);
        let win = (reason === "research_win_vote") || (score >= 50);
        let msg = win ? "ğŸ‰ èª¿æŸ»éšŠã®å‹åˆ©ï¼" : "ğŸ’€ ç›—è³Šã®å‹åˆ©ï¼";

        gameState.resultData = {
            msg: msg,
            score: score.toFixed(1),
            players: gameState.players
        };
        gameState.phase = 'result';
        sync();
    }

    function updateUI() {
        if (gameState.phase === 'setup') return;
        document.getElementById('setup-ui').style.display = 'none'; document.getElementById('game-ui').style.display = 'block';
        document.getElementById('day-label').innerText = "Day " + gameState.day;
        const me = gameState.players.find(x => x.id === myId);
        document.getElementById('my-faction-badge').innerText = me.faction === 'thief' ? "ğŸ•µï¸ ç›—è³Š" : "ğŸ” èª¿æŸ»éšŠ";
        document.getElementById('my-faction-badge').style.background = me.faction === 'thief' ? "var(--thief)" : "var(--accent)";

        if (gameState.phase !== 'result') {
            document.getElementById('result-panel').style.display = 'none';
            const grid = document.getElementById('status-grid'); grid.innerHTML = "";
            gameState.players.forEach((p, i) => {
                const isMe = p.id === myId; const act = (gameState.phase === 'action' && i === gameState.turnIdx);
                let statusText = isMe ? `ğŸ–:${p.food.toFixed(1)} ğŸ’:${p.treasure.toFixed(1)}<br><small>${p.ability}</small>` : `ğŸ–:?? ğŸ’:??<br><small>èƒ½åŠ›:??</small>`;
                if (!p.alive && p.reviveTimer > 0) statusText += `<br><span style='color:#a371f7'>è˜‡ç”Ÿå¾…æ©Ÿ: ${p.reviveTimer}æ—¥</span>`;
                
                grid.innerHTML += `<div class="card ${act ? 'my-turn' : ''} ${p.alive ? '' : 'dead'}">
                    <strong>${p.name}</strong> ${p.ready ? 'âœ…' : ''}<br>${p.alive ? 'â¤ï¸ ç”Ÿå­˜' : 'ğŸ’€ æ­»äº¡'}<br>
                    ${statusText}
                </div>`;
            });
        }

        document.getElementById('local-log').innerHTML = gameState.history.filter(h => h.isPublic || h.owner === myId).map(h => `<div style="color:${h.color}">[Day${h.day}] ${h.msg}</div>`).join("");
        document.getElementById('local-log').scrollTop = 99999;

        const isTurn = (gameState.phase === 'action' && gameState.players[gameState.turnIdx].id === myId);
        document.getElementById('action-panel').style.display = (isTurn && me.alive && me.ap > 0) ? 'block' : 'none';
        document.getElementById('rest-panel').style.display = (isTurn && (!me.alive || me.ap <= 0)) ? 'block' : 'none';
        document.getElementById('thief-traps').style.display = (me.faction === 'thief') ? 'block' : 'none';
        if(me.faction === 'thief') ['food_terror', 'leg_trap', 'theft', 'extra_food'].forEach(t => document.getElementById('trap-'+t).disabled = gameState.trapUsed[t]);

        const intPanel = document.getElementById('interaction-panel');
        if (gameState.phase === 'interaction' && me.alive) {
            intPanel.style.display = 'block';
            const gTo = document.getElementById('give-to'), kTo = document.getElementById('kill-to'), vTo = document.getElementById('vote-to');
            gTo.innerHTML = kTo.innerHTML = vTo.innerHTML = "";
            gameState.players.forEach(p => { if(p.id !== myId && p.alive) { const o = `<option value="${p.id}">${p.name}</option>`; gTo.innerHTML += o; kTo.innerHTML += o; vTo.innerHTML += o; } });
            document.getElementById('kill-ui').style.display = (me.ability === "ã‚¾ãƒ³ãƒ“" || me.ability === "ã‚®ãƒ–ã‚¢ãƒ³ãƒ‰ãƒ†ã‚¤ã‚¯") ? 'block' : 'none';
            document.getElementById('kill-btn').disabled = me.killedToday;
        } else intPanel.style.display = 'none';

        if (gameState.phase === 'result' && gameState.resultData) {
            const rd = gameState.resultData;
            document.getElementById('victory-msg').innerText = rd.msg;
            document.getElementById('score-breakdown').innerText = `æœ€çµ‚ã‚¹ã‚³ã‚¢: ${rd.score}`;
            const body = document.getElementById('final-body'); body.innerHTML = "";
            rd.players.forEach(p => {
                body.innerHTML += `<tr><td>${p.name}</td><td>${p.faction==='thief'?'ç›—è³Š':'èª¿æŸ»éšŠ'}</td><td>${p.alive?'ç”Ÿå­˜':'æ­»äº¡'}</td><td>${p.food.toFixed(1)}</td><td>${p.treasure.toFixed(1)}</td><td>${p.ability}</td></tr>`;
            });
            document.getElementById('result-panel').style.display = 'block';
            document.getElementById('action-panel').style.display = 'none';
            document.getElementById('interaction-panel').style.display = 'none';
        }
    }

    function pushLog(msg, color, owner = null) { gameState.history.push({ day: gameState.day, msg, color, owner, isPublic: (owner === null) }); }
    function sendAction(type, v1, v2) { const p = { type: 'action', playerId: myId, action: type, val: v1, prob: v2 }; if (isHost) processAction(p); else hostConn.send(p); closeOverlay(); }
    function markReady() { if (isHost) { gameState.players.find(x => x.id === myId).ready = true; checkPhaseEnd(); } else hostConn.send({ type: 'ready', pId: myId }); }
    function performGive() { 
        const v = parseFloat(document.getElementById('give-val').value); 
        const item = document.getElementById('give-item').value;
        const to = document.getElementById('give-to').value;
        const p = { type: 'give', from: myId, to, item, val: v };
        if (isHost) handleData(p); else hostConn.send(p); 
    }
    function performKill() { if (isHost) handleData({ type: 'kill', from: myId, to: document.getElementById('kill-to').value }); else hostConn.send({ type: 'kill', from: myId, to: document.getElementById('kill-to').value }); }
    function performVote() { if (isHost) handleData({ type: 'vote', to: document.getElementById('vote-to').value }); else hostConn.send({ type: 'vote', to: document.getElementById('vote-to').value }); }
    function cpuMove(c) { processAction({ action: c.food < 2 ? 'fish' : 'treasure', val: 0.4, prob: 20, playerId: c.id }); }
    function openOverlay(id) { 
        document.getElementById(id + '-overlay').style.display = 'flex'; const list = document.getElementById(id + '-list'); list.innerHTML = ""; 
        gameState.players.forEach((p, i) => { if (p.id !== myId && p.alive) { 
            if (id === 'spy') list.innerHTML += `<button class="btn" onclick="sendAction('spy', ${i})">${p.name}</button>`; 
            if (id === 'theft') list.innerHTML += `<button class="btn btn-thief" onclick="sendAction('trap', 'theft', {targetIdx: ${i}})">${p.name}</button>`; 
        }}); 
    }
    function closeOverlay() { document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); }
</script>
</body>
</html>
